<%- include('../layouts/user/header.ejs') %>

<!-- Start Hero Section -->
<div class="hero">
  <div class="container">
    <div class="row justify-content-between">
      <div class="col-lg-6">
        <div class="hero-img-wrap">
          <img
            src="images/familypic.png"
            class="img-fluid"
            style="height: 500px"
          />
        </div>
      </div>
      <div class="col-lg-6">
        <h2 style="color: white">Verify OTP</h2>
        <div class="intro-excerpt">
          <form action="" method="post">
            <div class="form-group">
              <label style="color: white">Enter your OTP</label><br />
              <div id="otp-inputs">
                <input type="text" class="otp-input" maxlength="1" />
                <input type="text" class="otp-input" maxlength="1" />
                <input type="text" class="otp-input" maxlength="1" />
                <input type="text" class="otp-input" maxlength="1" />
                <input type="text" class="otp-input" maxlength="1" />
                <input type="text" class="otp-input" maxlength="1" />
              </div>
              <input type="hidden" name="otp" id="otp" />
              <div id="timer" style="font-size: 2em;
      color:white;">60</div>
              <input type="hidden" name="user_id" value="<%= user_id %>" />
            </div>
            <div class="col">
              <button
              id="resendOtpButton"
                onclick="resendOtp('<%= user_id %>')"
                class="btn btn-primary"
                type="button"
              >
                Resend otp</button
              ><br /><br />
            </div>
            <div class="col">
              <button
                type="submit"
                class="btn btn-primary btn-lg"
                style="margin-left: 160px"
              >
                Verify OTP
              </button>
            </div>
            <div>
              <p>Don't have an account please <a href="/users">Register</a></p>
            </div>
            <% if (typeof message !== 'undefined') { %>
            <p style="color: white; font-weight:bold;"><%= message %> <a href="/login">login</a> now</p>
            <% } %>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>
<!-- End Hero Section -->
<script>
  function startResendTimer(){
    let resendBtn = document.getElementById('resendOtpButton');
    if(resendBtn){
      resendBtn.style.display = "none";
      
    setTimeout(function(){
      resendBtn.style.display ='block';
      console.log("resend button work after one minut")
    },60000)
    }else{
      console.error('resend button has some error')
    }
    
  }
  window.onload = startResendTimer();

    let userId ;
    
    async function resendOtp(userId) {
      try{
        userId= userId;
        console.log('receiving resendOTP request:',userId);
  
      // Check if userId is a non-empty string before making the request
      if (userId.trim() === "") {
          console.error("Invalid userId:", userId);
          alert("Invalid user ID");
          return;
        }
  
      const response = await fetch("/resendOtp", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({ userId }),
      });
  
      if (!response.ok) {
        throw new Error(`Failed to resend OTP. Server returned status ${response.status}`);
        }
  
        const data = await response.json();
        console.log('Resend OTP response: ',data);
        alert('OTP resent successfylly');
  
    } catch (error) {
      console.error('Error during OTP resend :', error);
      alert('Failed to resend OTP');
    }
  };
  
  //Shedule the resendOtp function after 5 minuts
  setTimeout(async() => {
    const userId = document.querySelector('#user_id').value;
    await resendOtp(userId);
  }, 1 * 60 * 1000);
  
  //timer
  let timeLeft = 60; // 1 minute (60 seconds)

    // Function to update the timer
    function updateTimer() {
      const timerElement = document.getElementById('timer');
      timerElement.textContent = timeLeft;
      
      if (timeLeft > 0) {
        timeLeft--;
        setTimeout(updateTimer, 1000); // Call updateTimer every 1 second
      } else {
        timerElement.textContent = 'Time is up!';
      }
    }

    // Start the timer
    updateTimer();
    document.addEventListener("DOMContentLoaded", () => {
    const inputs = document.querySelectorAll('.otp-input');

    inputs.forEach((input, index) => {
      input.addEventListener('input', () => {
        if (input.value.length > 0 && index < inputs.length - 1) {
          inputs[index + 1].focus();
        }
      });

      input.addEventListener('keydown', (e) => {
        if (e.key === 'Backspace' && input.value.length === 0 && index > 0) {
          inputs[index - 1].focus();
        }
      });
    });
  });
</script>
<%- include('../layouts/user/footerlogin.ejs') %>
